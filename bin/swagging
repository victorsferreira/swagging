#!/usr/bin/env node

const cwd = process.cwd();
const execa = require('execa');
const path = require('path');
const fs = require('fs');
const config = require('../package');
const helpers = require('../helpers');

const { displayName, name } = config;
const targetYamlPath = helpers.getTargetYamlPath();

if (!fs.existsSync(targetYamlPath)) {
  console.log(`${displayName} found a critical error:`, 'There is no swagger.yaml file in the root path. Fix it and try again.');
  process.exit();
}

const callerPackage = require(path.join(cwd, 'package.json'));

const { name: callerPackageName } = callerPackage;
const workingPath = helpers.resolveWorkingPath(name, callerPackageName);

const std = execa.shell(`npm-run gulp --gulpfile ${workingPath}gulpfile.js & npm-run swagger project edit ${workingPath} & npm-run http-server -o -p 3000 ${workingPath}public/ui -c-1`);

std.stdout.on('data', function (data) {
  console.log(`${displayName} says:`, data.toString());
});

std.stderr.on('data', function (data) {
  console.log(`${displayName} found an error:`, data.toString());
});

std.on('exit', function (code) {
  console.log(`${displayName} finished working:`, code.toString());
});